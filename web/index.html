<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rhythm Web Transpiler</title>
    <script type="importmap">
      {
        "imports": {
          "codemirror": "https://cdn.jsdelivr.net/npm/codemirror@6.0.1/dist/index.js",
          "@codemirror/lang-javascript": "https://cdn.jsdelivr.net/npm/@codemirror/lang-javascript@6.2.2/dist/index.js",
          "@codemirror/view": "https://cdn.jsdelivr.net/npm/@codemirror/view@6.26.3/dist/index.js",
          "@codemirror/state": "https://cdn.jsdelivr.net/npm/@codemirror/state@6.4.1/dist/index.js",
          "@codemirror/language": "https://cdn.jsdelivr.net/npm/@codemirror/language@6.10.2/dist/index.js",
          "@codemirror/commands": "https://cdn.jsdelivr.net/npm/@codemirror/commands@6.6.0/dist/index.js",
          "@codemirror/search": "https://cdn.jsdelivr.net/npm/@codemirror/search@6.5.6/dist/index.js",
          "@codemirror/autocomplete": "https://cdn.jsdelivr.net/npm/@codemirror/autocomplete@6.16.2/dist/index.js",
          "@codemirror/lint": "https://cdn.jsdelivr.net/npm/@codemirror/lint@6.8.1/dist/index.js",
          "@lezer/common": "https://cdn.jsdelivr.net/npm/@lezer/common@1.2.1/dist/index.js",
          "@lezer/highlight": "https://cdn.jsdelivr.net/npm/@lezer/highlight@1.2.0/dist/index.js",
          "@lezer/lr": "https://cdn.jsdelivr.net/npm/@lezer/lr@1.4.1/dist/index.js",
          "@lezer/javascript": "https://cdn.jsdelivr.net/npm/@lezer/javascript@1.4.17/dist/index.js",
          "style-mod": "https://cdn.jsdelivr.net/npm/style-mod@4.1.2/src/style-mod.js",
          "crelt": "https://cdn.jsdelivr.net/npm/crelt@1.0.6/index.js",
          "w3c-keyname": "https://cdn.jsdelivr.net/npm/w3c-keyname@2.2.8/index.js"
        }
      }
    </script>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="page-header">
      <h1>Rhythm Web Transpiler</h1>
      <p class="tagline">
        Compile Rhythm code to JavaScript directly in your browser and run it
        without any server round-trips.
      </p>
    </header>

    <main class="layout">
      <section class="panel">
        <div class="panel-header">
          <h2>Source</h2>
          <label class="toggle">
            <input type="checkbox" id="noLoop" />
            Disable loop constructs (force recursion)
          </label>
        </div>
        <div id="editor" class="code-input"></div>
        <div class="actions">
          <button id="compile" type="button">Compile</button>
          <button id="compileRun" type="button" class="primary">Compile &amp; Run</button>
        </div>
        <label class="stdin-label" for="stdinInput">Program input (optional)</label>
        <textarea
          id="stdinInput"
          class="stdin-input"
          spellcheck="false"
          aria-label="Program standard input"
        ></textarea>
      </section>

      <section class="panel">
        <div class="panel-header">
          <h2>Program output</h2>
          <p
            id="executionTime"
            class="execution-time hidden"
            aria-live="polite"
          ></p>
        </div>
        <div class="output-group">
          <div>
            <h3>stdout</h3>
            <pre id="stdout" class="output-block" aria-label="Program stdout"></pre>
          </div>
          <div id="stderrSection" class="hidden">
            <h3>stderr</h3>
            <pre id="stderr" class="output-block error" aria-label="Program stderr"></pre>
          </div>
        </div>

        <details class="foldable" id="jsSection" open>
          <summary>Generated JavaScript</summary>
          <div class="foldable-content">
            <textarea
              id="jsOutput"
              class="code-output"
              spellcheck="false"
              aria-label="Generated JavaScript"
              readonly
            ></textarea>
          </div>
        </details>
      </section>
    </main>

    <footer class="status-bar" id="status" data-tone="info">
      Loading transpiler&hellip;
    </footer>

    <script type="module">
      const buildVersion = (() => {
        const fromMeta = document
          .querySelector("meta[name='rhythm-build']")
          ?.getAttribute("content");
        if (fromMeta && fromMeta.trim().length > 0) {
          return fromMeta.trim();
        }

        const lastModified = document.lastModified || "";
        const numeric = lastModified.replace(/\D/g, "");
        if (numeric.length > 0) {
          return numeric;
        }

        return `${Date.now()}`;
      })();

      const moduleUrl = new URL("./app.js", import.meta.url);
      if (buildVersion && buildVersion.length > 0) {
        moduleUrl.searchParams.set("v", buildVersion);
      }

      import(moduleUrl.href).catch((error) => {
        console.error("Failed to load Rhythm app.js module", error);
        const statusBar = document.getElementById("status");
        if (statusBar) {
          statusBar.textContent = `Failed to load Rhythm app.js module: ${
            error && error.message ? error.message : error
          }`;
          statusBar.dataset.tone = "error";
        }
      });
    </script>
  </body>
</html>
